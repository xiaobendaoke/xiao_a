# å°a (XiaoA) å…¨æ™¯æ¶æ„ä¸å®ç°è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†æ­ç§˜å°açš„æ‰€æœ‰åŠŸèƒ½èƒŒåçš„å®ç°é€»è¾‘ï¼Œé€‚åˆå¼€å‘è€…é˜…è¯»å’ŒäºŒæ¬¡å¼€å‘ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#2-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
3. [æ•°æ®æµè¯¦è§£](#3-æ•°æ®æµè¯¦è§£)
4. [æ‹ŸäººåŒ–ç³»ç»Ÿ](#4-æ‹ŸäººåŒ–ç³»ç»Ÿ)
5. [è®°å¿†ç³»ç»Ÿ](#5-è®°å¿†ç³»ç»Ÿ)
6. [è®¤çŸ¥ç³»ç»Ÿ](#6-è®¤çŸ¥ç³»ç»Ÿ)
7. [èƒ½åŠ›ç³»ç»Ÿ](#7-èƒ½åŠ›ç³»ç»Ÿ)
8. [æ•°æ®åº“è®¾è®¡](#8-æ•°æ®åº“è®¾è®¡)
9. [å…³é”®ç®—æ³•](#9-å…³é”®ç®—æ³•)
10. [é…ç½®è¯¦è§£](#10-é…ç½®è¯¦è§£)

---

## 1. æ•´ä½“æ¶æ„

### 1.1 ç³»ç»Ÿåˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ¥å…¥å±‚ (Access Layer)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NapCat (OneBot v11)                                                        â”‚
â”‚  â”œâ”€â”€ åŠŸèƒ½ï¼šQQåè®®æ¡¥æ¥ã€è¯­éŸ³æ–‡ä»¶å¤„ç†ã€æ¶ˆæ¯æ ¼å¼è½¬æ¢                                â”‚
â”‚  â”œâ”€â”€ ç«¯å£ï¼š6099 (WebUI), 8080 (OneBot WebSocket)                            â”‚
â”‚  â””â”€â”€ é…ç½®ï¼šnapcat/config/onebot11_<QQå·>.json                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           æ¡†æ¶å±‚ (Framework Layer)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NoneBot2 (FastAPI)                                                         â”‚
â”‚  â”œâ”€â”€ æ ¸å¿ƒï¼šæ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ã€å®šæ—¶ä»»åŠ¡è°ƒåº¦(apscheduler)                 â”‚
â”‚  â”œâ”€â”€ é€‚é…å™¨ï¼šOneBot V11 Adapter                                              â”‚
â”‚  â””â”€â”€ é’©å­ï¼šon_message, on_notice, scheduled_job                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           æ’ä»¶å±‚ (Plugin Layer)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  companion_core (æ ¸å¿ƒæ’ä»¶)                                                   â”‚
â”‚  â”œâ”€â”€ handlers.py       - æ¶ˆæ¯å¤„ç†æ€»å…¥å£                                        â”‚
â”‚  â”œâ”€â”€ llm_core.py       - LLMå¯¹è¯ç¼–æ’                                          â”‚
â”‚  â”œâ”€â”€ memory.py         - ç¬æ—¶è®°å¿†ç®¡ç†                                         â”‚
â”‚  â”œâ”€â”€ rag_core.py       - RAGé•¿æœŸè®°å¿†                                          â”‚
â”‚  â”œâ”€â”€ mood.py           - æƒ…ç»ªç³»ç»Ÿ                                             â”‚
â”‚  â”œâ”€â”€ db.py             - æ•°æ®åº“æ“ä½œ                                           â”‚
â”‚  â””â”€â”€ ...                                                                              â”‚
â”‚                                                                                      â”‚
â”‚  finance_daily (è´¢ç»æ—¥æŠ¥æ’ä»¶)                                                 â”‚
â”‚  â””â”€â”€ ç‹¬ç«‹çš„è‚¡ç¥¨åˆ†æå’Œæ¨é€ç³»ç»Ÿ                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           èƒ½åŠ›å±‚ (Capability Layer)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ‹ŸäººåŒ–ç³»ç»Ÿ                                                                  â”‚
â”‚  â”œâ”€â”€ bubble_splitter.py    - æ°”æ³¡åˆ†å‰²ç®—æ³•                                      â”‚
â”‚  â”œâ”€â”€ send_rhythm.py        - å‘é€èŠ‚å¥æ§åˆ¶                                      â”‚
â”‚  â”œâ”€â”€ typing_speed.py       - æ‰“å­—é€Ÿåº¦è®¡ç®—                                      â”‚
â”‚  â””â”€â”€ reply_manager.py      - æ¶ˆæ¯å‘é€ç®¡ç†                                      â”‚
â”‚                                                                                      â”‚
â”‚  è®¤çŸ¥ç³»ç»Ÿ                                                                    â”‚
â”‚  â”œâ”€â”€ llm_insights.py       - ç”¨æˆ·æ´å¯Ÿæå–                                      â”‚
â”‚  â”œâ”€â”€ proactive.py          - ä¸»åŠ¨äº’åŠ¨                                          â”‚
â”‚  â””â”€â”€ info_agent/           - æ™ºèƒ½ä¿¡æ¯æ¨é€                                      â”‚
â”‚                                                                                      â”‚
â”‚  å·¥å…·ç³»ç»Ÿ                                                                    â”‚
â”‚  â”œâ”€â”€ llm_news.py           - æ–°é—»æœç´¢                                          â”‚
â”‚  â”œâ”€â”€ llm_web.py            - URLæ€»ç»“                                           â”‚
â”‚  â”œâ”€â”€ llm_vision.py         - å›¾ç‰‡ç†è§£                                          â”‚
â”‚  â”œâ”€â”€ llm_stock.py          - è‚¡ç¥¨åˆ†æ                                          â”‚
â”‚  â”œâ”€â”€ scheduler_custom.py   - æ—¥ç¨‹æé†’                                          â”‚
â”‚  â”œâ”€â”€ memo.py               - å¤‡å¿˜å½•                                            â”‚
â”‚  â””â”€â”€ weather_push.py       - å¤©æ°”æ¨é€                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           å­˜å‚¨å±‚ (Storage Layer)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SQLite (data.db)                                                           â”‚
â”‚  â”œâ”€â”€ chats              - èŠå¤©è®°å½•                                            â”‚
â”‚  â”œâ”€â”€ user_profile       - ç”¨æˆ·ç”»åƒ                                            â”‚
â”‚  â”œâ”€â”€ mood               - å¿ƒæƒ…å€¼                                              â”‚
â”‚  â”œâ”€â”€ memos              - å¤‡å¿˜å½•                                              â”‚
â”‚  â”œâ”€â”€ schedules          - æ—¥ç¨‹æé†’                                            â”‚
â”‚  â””â”€â”€ user_insights      - ç”¨æˆ·æ´å¯Ÿ                                            â”‚
â”‚                                                                                      â”‚
â”‚  ChromaDB (å‘é‡æ•°æ®åº“)                                                       â”‚
â”‚  â””â”€â”€ RAGé•¿æœŸè®°å¿†å­˜å‚¨                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           å¤–éƒ¨æœåŠ¡å±‚ (External Services)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LLM API                                                                    â”‚
â”‚  â”œâ”€â”€ SiliconFlow / DeepSeek / OpenAI (å¯¹è¯)                                  â”‚
â”‚  â”‚   â””â”€â”€ æ”¯æŒå¤šKeyè½®è¯¢ä¸è‡ªåŠ¨é‡è¯•ï¼ˆResilienceï¼‰                                  â”‚
â”‚  â””â”€â”€ DashScope (è¯­éŸ³ã€å›¾ç‰‡)                                                   â”‚
â”‚                                                                                      â”‚
â”‚  æ•°æ®API                                                                    â”‚
â”‚  â”œâ”€â”€ Google CSE        - è”ç½‘æœç´¢                                             â”‚
â”‚  â”œâ”€â”€ Open-Meteo        - å¤©æ°”æ•°æ®                                             â”‚
â”‚  â”œâ”€â”€ ä¸œæ–¹è´¢å¯Œ          - è‚¡ç¥¨è¡Œæƒ…                                             â”‚
â”‚  â””â”€â”€ TheMealDB         - èœè°±æ•°æ®                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¨¡å—ä¾èµ–å›¾

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   handlers.py   â”‚
                         â”‚   (æ¶ˆæ¯å…¥å£)     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                   â”‚                   â”‚
              â–¼                   â–¼                   â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚llm_core.py   â”‚   â”‚ scheduler_   â”‚   â”‚   memo.py    â”‚
       â”‚(å¯¹è¯ç¼–æ’)     â”‚   â”‚ custom.py    â”‚   â”‚  (å¤‡å¿˜å½•)     â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚(æ—¥ç¨‹æé†’)     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚           â”‚          â”‚
    â–¼         â–¼         â–¼           â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚memoryâ”‚ â”‚ mood â”‚ â”‚  RAG   â”‚ â”‚  skills  â”‚ â”‚  news   â”‚
â”‚(ç¬æ—¶) â”‚ â”‚(æƒ…ç»ª)â”‚ â”‚(é•¿æœŸ)  â”‚ â”‚(ä¸“ä¸šèƒ½åŠ›)â”‚ â”‚ (æœç´¢)  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚           â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ reply_managerâ”‚
                  â”‚ (æ¶ˆæ¯å‘é€)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚             â”‚             â”‚
           â–¼             â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚bubble_     â”‚ â”‚  send_   â”‚ â”‚  typing_ â”‚
    â”‚splitter    â”‚ â”‚ rhythm   â”‚ â”‚  speed   â”‚
    â”‚(æ°”æ³¡åˆ†å‰²)  â”‚ â”‚(èŠ‚å¥æ§åˆ¶)â”‚ â”‚(é€Ÿåº¦è®¡ç®—)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 2.1 handlers.py - æ¶ˆæ¯å¤„ç†æ€»å…¥å£

**èŒè´£**ï¼šæ‰€æœ‰ç§èŠæ¶ˆæ¯çš„å…¥å£ï¼Œè´Ÿè´£æŒ‡ä»¤è¯†åˆ«å’Œæµç¨‹åˆ†å‘ã€‚

**å¤„ç†æµç¨‹**ï¼š

```python
# ä¼ªä»£ç å±•ç¤ºå¤„ç†æµç¨‹
async def handle_private_chat(event):
    user_id = event.user_id
    message = event.get_message()
    
    # 1. è¯­éŸ³æ¶ˆæ¯å¤„ç†
    if is_voice(message):
        return await handle_voice(user_id, message)
    
    # 2. åŸºç¡€æ£€æŸ¥
    await check_biology_clock(user_id)      # ç”Ÿç‰©é’Ÿæ£€æŸ¥
    await check_fake_busy(user_id)          # å‡å¿™ç¢Œæ£€æŸ¥
    await check_rate_limit(user_id)         # é™æµæ£€æŸ¥
    
    # 3. æŒ‡ä»¤è¯†åˆ«ï¼ˆä¼˜å…ˆçº§é¡ºåºï¼‰
    if is_schedule_command(text):           # æ—¥ç¨‹æé†’
        return await handle_schedule(user_id, text)
    if is_memo_command(text):               # å¤‡å¿˜å½•
        return await handle_memo(user_id, text)
    if is_stock_command(text):              # è‚¡ç¥¨æŸ¥è¯¢
        return await handle_stock(user_id, text)
    if is_summary_request(text):            # URLæ€»ç»“è·Ÿè¿›
        return await handle_summary(user_id, text)
    if has_image(message):                  # å›¾ç‰‡ç†è§£
        return await handle_image(user_id, message, text)
    if has_url(text):                       # URLè‡ªåŠ¨å¤„ç†
        return await handle_url(user_id, text)
    
    # 4. æ™®é€šå¯¹è¯
    reply = await get_ai_reply(user_id, text)
    await send_reply(user_id, reply)
```

**å…³é”®çŠ¶æ€æœº**ï¼š

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â”‚
    â”œâ”€â†’ è¯­éŸ³æ¶ˆæ¯ â”€â”€â”€â”€â”€â”€â”€â†’ ASR â†’ LLM â†’ TTS â†’ å‘é€
    â”‚
    â”œâ”€â†’ æ–‡æœ¬æ¶ˆæ¯
    â”‚       â”‚
    â”‚       â”œâ”€â†’ ç”Ÿç‰©é’Ÿæ£€æŸ¥ â”€â”€â†’ æ‹’ç»/å›°å€¦å›å¤
    â”‚       â”‚
    â”‚       â”œâ”€â†’ å‡å¿™ç¢Œæ£€æŸ¥ â”€â”€â†’ å¿™ç¢Œå›å¤/å·²è¯»ä¸å›
    â”‚       â”‚
    â”‚       â”œâ”€â†’ é™æµæ£€æŸ¥ â”€â”€â”€â”€â†’ ä¸¢å¼ƒ
    â”‚       â”‚
    â”‚       â””â”€â†’ æŒ‡ä»¤è¯†åˆ«
    â”‚               â”‚
    â”‚               â”œâ”€â†’ æ—¥ç¨‹æé†’æŒ‡ä»¤ â”€â”€â†’ è§£ææ—¶é—´ â†’ å­˜å‚¨ â†’ ç¡®è®¤
    â”‚               â”œâ”€â†’ å¤‡å¿˜å½•æŒ‡ä»¤ â”€â”€â”€â”€â†’ ä¿å­˜/æŸ¥è¯¢ â†’ å›å¤
    â”‚               â”œâ”€â†’ è‚¡ç¥¨æŒ‡ä»¤ â”€â”€â”€â”€â”€â”€â†’ æŸ¥è¡Œæƒ… â†’ LLMåˆ†æ â†’ å›å¤
    â”‚               â”œâ”€â†’ URLè·Ÿè¿› â”€â”€â”€â”€â”€â”€â†’ æŠ“å– â†’ æ€»ç»“ â†’ å›å¤
    â”‚               â”œâ”€â†’ å›¾ç‰‡æ¶ˆæ¯ â”€â”€â”€â”€â”€â†’ è§†è§‰ç†è§£ â†’ å›å¤
    â”‚               â”œâ”€â†’ URLæ£€æµ‹ â”€â”€â”€â”€â”€â”€â†’ è¯¢é—®æ˜¯å¦æ€»ç»“
    â”‚               â”‚
    â”‚               â””â”€â†’ æ™®é€šå¯¹è¯ â”€â”€â”€â”€â”€â†’ æ„å»ºPrompt â†’ LLM â†’ å‘é€
    â”‚
    â””â”€â†’ ç­‰å¾…ä¸‹ä¸€æ¡æ¶ˆæ¯
```

### 2.2 llm_core.py - LLMå¯¹è¯ç¼–æ’

**èŒè´£**ï¼šæ„å»ºå®Œæ•´çš„Promptï¼Œè°ƒç”¨LLMï¼Œå¤„ç†å“åº”ã€‚

**Promptæ„å»ºé¡ºåº**ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼Œè¶Šæ™šåŠ å…¥æƒé‡è¶Šé«˜ï¼‰ï¼š

```python
def build_messages(user_id, user_text, **kwargs):
    messages = []
    
    # 1. ç³»ç»Ÿäººè®¾ï¼ˆæœ€åŸºç¡€ï¼‰
    messages.append({"role": "system", "content": SYSTEM_PROMPT})
    
    # 2. ä¸–ç•Œè®¾å®š
    messages.append({
        "role": "system", 
        "content": f"ç°åœ¨æ—¶é—´ï¼š{get_time()}, å¤©æ°”ï¼š{get_weather()}"
    })
    
    # 3. ç”¨æˆ·ç”»åƒ
    profile = get_user_profile(user_id)
    messages.append({
        "role": "system",
        "content": f"ç”¨æˆ·ä¿¡æ¯ï¼š{profile}"
    })
    
    # 4. Skillsèƒ½åŠ›ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if skill_prompt := route_skill(user_text):
        messages.append({"role": "system", "content": skill_prompt})
    
    # 5. RAGé•¿æœŸè®°å¿†ï¼ˆéæ–°é—»æŸ¥è¯¢æ—¶ï¼‰
    if not is_news_query(user_text):
        memories = retrieve_memories(user_id, user_text)
        messages.append({"role": "system", "content": f"ç›¸å…³è®°å¿†ï¼š{memories}"})
    
    # 6. è”ç½‘æœç´¢ç»“æœï¼ˆæ–°é—»æŸ¥è¯¢æ—¶ï¼‰
    if is_news_query(user_text):
        search_results = search_web(user_text)
        messages.append({"role": "system", "content": search_results})
    
    # 7. å½“å‰å¿ƒæƒ…
    mood = get_mood(user_id)
    messages.append({
        "role": "system",
        "content": f"å½“å‰å¿ƒæƒ…ï¼š{mood}ï¼Œ{get_mood_instruction(mood)}"
    })
    
    # 8. å†å²å¯¹è¯ï¼ˆæœ€è¿‘20è½®ï¼‰
    history = get_recent_chats(user_id, limit=20)
    messages.extend(history)
    
    # 9. ç”¨æˆ·å½“å‰æ¶ˆæ¯
    messages.append({"role": "user", "content": user_text})
    
    # 10. æœ€åæŒ‡ä»¤ï¼ˆè¦†ç›–å‰é¢çš„è§„åˆ™ï¼‰
    messages.append({
        "role": "system",
        "content": "ï¼ˆSystem: ç°åœ¨çš„è¯­å¢ƒæ˜¯å¾®ä¿¡é—²èŠã€‚è¯·æŠŠå›å¤å†™å¾—çŸ­ä¸€ç‚¹ã€æ¾å¼›ä¸€ç‚¹ã€å£è¯­åŒ–ä¸€ç‚¹ã€‚ï¼‰"
    })
    
    return messages
```

**LLMå“åº”å¤„ç†**ï¼š

```python
async def get_ai_reply(user_id, user_text):
    # 1. æ„å»ºPrompt
    messages = build_messages(user_id, user_text)
    
    # 2. è°ƒç”¨LLM
    response = await client.chat.completions.create(
        model=model,
        messages=messages,
        temperature=get_temperature(user_id),  # æ ¹æ®å¿ƒæƒ…è°ƒæ•´
        max_tokens=get_max_tokens(user_text),  # æ ¹æ®åœºæ™¯è°ƒæ•´
    )
    
    raw_content = response.choices[0].message.content
    
    # 3. è§£ææ ‡ç­¾
    clean_reply, mood_change, updates = extract_tags_and_clean(raw_content)
    
    # 4. æ›´æ–°çŠ¶æ€
    if mood_change:
        mood_manager.update_mood(user_id, mood_change)
    for key, value in updates:
        save_profile_item(user_id, key, value)
    
    # 5. ä¿å­˜è®°å¿†
    add_memory(user_id, "user", user_text)
    add_memory(user_id, "assistant", clean_reply)
    
    # 6. å¼‚æ­¥å­˜å…¥RAG
    asyncio.create_task(add_document(
        f"User: {user_text}\nXiaoA: {clean_reply}",
        metadata={"user_id": user_id, "type": "chat_history"}
    ))
    
    return clean_reply
```

### 2.3 memory.py - ç¬æ—¶è®°å¿†

**èŒè´£**ï¼šç®¡ç†æœ€è¿‘20è½®å¯¹è¯ï¼Œæä¾›ä¸Šä¸‹æ–‡è¿è´¯æ€§ã€‚

**å®ç°**ï¼š

```python
# å†…å­˜ç¼“å­˜
_chat_history: dict[str, list[dict]] = {}

def add_memory(user_id: str, role: str, content: str):
    """æ·»åŠ ä¸€æ¡è®°å¿†"""
    if user_id not in _chat_history:
        _chat_history[user_id] = []
    
    _chat_history[user_id].append({
        "role": role,
        "content": content,
        "timestamp": time.time()
    })
    
    # åªä¿ç•™æœ€è¿‘20è½®ï¼ˆ40æ¡æ¶ˆæ¯ï¼‰
    if len(_chat_history[user_id]) > 40:
        _chat_history[user_id] = _chat_history[user_id][-40:]
    
    # æŒä¹…åŒ–åˆ°SQLiteï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
    asyncio.create_task(_persist_to_db(user_id, role, content))

def get_recent_context(user_id: str, limit: int = 20) -> list[dict]:
    """è·å–æœ€è¿‘Nè½®å¯¹è¯"""
    history = _chat_history.get(user_id, [])
    
    # æ ¼å¼è½¬æ¢
    messages = []
    for msg in history[-limit*2:]:  # *2å› ä¸ºæ¯è½®æœ‰user+assistant
        messages.append({
            "role": msg["role"],
            "content": msg["content"]
        })
    
    return messages
```

**ä¸ºä»€ä¹ˆéœ€è¦"ç¬æ—¶è®°å¿†"ï¼Ÿ**

1. **é€Ÿåº¦**ï¼šå†…å­˜è¯»å–æ¯”SQLiteå¿«100å€
2. **ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶**ï¼šLLMæœ‰tokené™åˆ¶ï¼Œåªä¼ æœ€è¿‘20è½®
3. **ä¸´æ—¶çŠ¶æ€**ï¼šä¸éœ€è¦é•¿æœŸä¿å­˜çš„"æ­£åœ¨è¿›è¡Œçš„è¯é¢˜"

### 2.4 rag_core.py - RAGé•¿æœŸè®°å¿†

**èŒè´£**ï¼šå‘é‡å­˜å‚¨å’Œæ£€ç´¢å†å²å¯¹è¯ï¼Œå®ç°"å›å¿†"èƒ½åŠ›ã€‚

**æ¶æ„**ï¼š

```
ç”¨æˆ·å¯¹è¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ–‡æœ¬é¢„å¤„ç†     â”‚ æ¸…æ´—ã€è¿‡æ»¤ã€æ ¼å¼åŒ–
â”‚    - å»é™¤è¡¨æƒ…     â”‚
â”‚    - åˆå¹¶å¤šè½®     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Embedding     â”‚ å°†æ–‡æœ¬è½¬ä¸ºå‘é‡
â”‚    æ¨¡å‹ï¼šBAAI/   â”‚
â”‚    bge-m3        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ChromaDBå­˜å‚¨   â”‚ æŒä¹…åŒ–å‘é‡
â”‚    - collection  â”‚
â”‚    - metadata    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ£€ç´¢          â”‚ å½“ç”¨æˆ·æåˆ°"ç«é”…"æ—¶
â”‚    - å‘é‡åŒ–æŸ¥è¯¢  â”‚
â”‚    - ç›¸ä¼¼åº¦æ’åº  â”‚
â”‚    - è¿”å›Top3    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç **ï¼š

```python
# RAGæ ¸å¿ƒå®ç°
from chromadb import Client, Settings

_client: Client | None = None
_collection = None

async def get_collection():
    """è·å–æˆ–åˆå§‹åŒ–ChromaDBé›†åˆ"""
    global _client, _collection
    
    if _collection is not None:
        return _collection
    
    _client = Client(Settings(
        chroma_db_impl="duckdb+parquet",
        persist_directory="./chroma_db"
    ))
    
    _collection = _client.get_or_create_collection(
        name="chat_memories",
        metadata={"hnsw:space": "cosine"}
    )
    
    return _collection

async def add_document(text: str, metadata: dict) -> bool:
    """æ·»åŠ æ–‡æ¡£åˆ°RAG"""
    if len(text) < 5:  # å¤ªçŸ­çš„å¿½ç•¥
        return False
    
    # 1. ç”Ÿæˆå‘é‡
    embedding = await get_text_embedding(text)
    if not embedding:
        return False
    
    # 2. ç”Ÿæˆå”¯ä¸€ID
    doc_id = hashlib.md5(f"{metadata['user_id']}:{text}".encode()).hexdigest()
    
    # 3. å­˜å‚¨
    collection = await get_collection()
    collection.add(
        ids=[doc_id],
        embeddings=[embedding],
        documents=[text],
        metadatas=[metadata]
    )
    
    return True

async def search_memories(user_id: str, query: str, top_k: int = 3) -> list[str]:
    """æœç´¢ç›¸å…³è®°å¿†"""
    # 1. æŸ¥è¯¢å‘é‡åŒ–
    query_embedding = await get_text_embedding(query)
    
    # 2. æ£€ç´¢
    collection = await get_collection()
    results = collection.query(
        query_embeddings=[query_embedding],
        n_results=top_k,
        where={"user_id": user_id},  # åªæœç´¢è¯¥ç”¨æˆ·çš„
        include=["documents", "metadatas", "distances"]
    )
    
    # 3. è¿‡æ»¤ä½ç›¸ä¼¼åº¦ï¼ˆè·ç¦»>0.3è®¤ä¸ºæ˜¯æ— å…³çš„ï¼‰
    memories = []
    for doc, distance in zip(results["documents"][0], results["distances"][0]):
        if distance < 0.3:  # cosineè·ç¦»ï¼Œè¶Šå°è¶Šç›¸ä¼¼
            memories.append(doc)
    
    return memories
```

**æ—¶é—´è¡°å‡æƒé‡**ï¼š

ä¸ºäº†è®©"æœ€è¿‘çš„è®°å¿†"æ›´é‡è¦ï¼ŒRAGæ£€ç´¢åä¼šæ ¹æ®æ—¶é—´åŠ æƒï¼š

```python
def apply_time_decay(results: list[dict]) -> list[dict]:
    """åº”ç”¨æ—¶é—´è¡°å‡"""
    now = time.time()
    
    for result in results:
        age_days = (now - result["created_at"]) / 86400
        # è¶…è¿‡30å¤©çš„è®°å¿†æƒé‡é™ä½
        decay_factor = max(0.3, 1.0 - (age_days / 30) * 0.7)
        result["score"] *= decay_factor
    
    # é‡æ–°æ’åº
    return sorted(results, key=lambda x: x["score"], reverse=True)
```

### 2.5 mood.py - æƒ…ç»ªç³»ç»Ÿ

**èŒè´£**ï¼šç»´æŠ¤ç”¨æˆ·çš„å¿ƒæƒ…å€¼ï¼ˆ-100~100ï¼‰ï¼Œå½±å“å›å¤è¯­æ°”å’Œè¯­éŸ³å‚æ•°ã€‚

**çŠ¶æ€å®šä¹‰**ï¼š

```
å¿ƒæƒ…å€¼èŒƒå›´ï¼š-100 ~ +100

+80 ~ +100: è¶…çº§å…´å¥‹
+30 ~ +79:  å¼€å¿ƒ
-10 ~ +29:  å¹³é™ï¼ˆé»˜è®¤ï¼‰
-50 ~ -11:  çƒ¦èº/éƒé—·
-100 ~ -51: ç”Ÿæ°”/å´©æºƒ
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

```python
class MoodManager:
    def __init__(self):
        self._moods: dict[str, int] = {}      # å†…å­˜ç¼“å­˜
        self._timestamps: dict[str, float] = {}  # ä¸Šæ¬¡æ›´æ–°æ—¶é—´
    
    def get_user_mood(self, user_id: str) -> int:
        """è·å–å½“å‰å¿ƒæƒ…ï¼ˆè‡ªåŠ¨åº”ç”¨æ—¶é—´è¡°å‡ï¼‰"""
        now = time.time()
        
        # ä»æ•°æ®åº“åŠ è½½ï¼ˆå¦‚æœæ²¡æœ‰ç¼“å­˜ï¼‰
        if user_id not in self._moods:
            self._moods[user_id], self._timestamps[user_id] = self._load_from_db(user_id)
        
        current = self._moods[user_id]
        last_ts = self._timestamps[user_id]
        
        # æ—¶é—´è¡°å‡ï¼šæ¯60ç§’æ¢å¤1ç‚¹ï¼ˆå‘0å›å½’ï¼‰
        delta_seconds = now - last_ts
        decay_points = int(delta_seconds / 60)
        
        if decay_points > 0 and current != 0:
            if current > 0:
                new_mood = max(0, current - decay_points)
            else:
                new_mood = min(0, current + decay_points)
            
            # ä¿å­˜æ›´æ–°
            self._moods[user_id] = new_mood
            self._timestamps[user_id] = now
            self._save_to_db(user_id, new_mood)
            
            return new_mood
        
        return current
    
    def update_mood(self, user_id: str, change: int) -> int:
        """æ›´æ–°å¿ƒæƒ…ï¼ˆå•æ¬¡å˜åŒ–é™åˆ¶åœ¨-5~+5ï¼‰"""
        # å…ˆè·å–å½“å‰ï¼ˆå·²è¡°å‡ï¼‰
        current = self.get_user_mood(user_id)
        
        # é™åˆ¶å•æ¬¡å˜åŒ–å¹…åº¦ï¼ˆé¿å…å‰§çƒˆæ³¢åŠ¨ï¼‰
        change = max(-5, min(5, change))
        
        # è®¡ç®—æ–°å€¼å¹¶é™åˆ¶èŒƒå›´
        new_mood = max(-100, min(100, current + change))
        
        # ä¿å­˜
        now = time.time()
        self._moods[user_id] = new_mood
        self._timestamps[user_id] = now
        self._save_to_db(user_id, new_mood)
        
        return new_mood
    
    def get_mood_desc(self, user_id: str) -> str:
        """è·å–å¿ƒæƒ…æè¿°ï¼ˆç”¨äºPromptï¼‰"""
        v = self.get_user_mood(user_id)
        if v >= 80: return "å¿ƒç†çŠ¶æ€ï¼šè¶…çº§å…´å¥‹ï¼Œæ¨ä¸å¾—é©¬ä¸ŠæŠ±ä½ä»–ï¼Œæ»¡çœ¼æ˜Ÿæ˜Ÿã€‚"
        if v >= 30: return "å¿ƒç†çŠ¶æ€ï¼šå¿ƒæƒ…ä¸é”™ï¼Œæ¯”è¾ƒç”œï¼Œçœ‹ä»€ä¹ˆéƒ½é¡ºçœ¼ã€‚"
        if v >= -10: return "å¿ƒç†çŠ¶æ€ï¼šå†…å¿ƒå¹³é™ï¼Œæ¯”è¾ƒéšæ€§ï¼Œæ‡’æ´‹æ´‹çš„ã€‚"
        if v >= -50: return "å¿ƒç†çŠ¶æ€ï¼šæœ‰ç‚¹çƒ¦èº/éƒé—·ï¼Œä¸æƒ³å¤šè¯´è¯ï¼Œå¯¹ä»–æœ‰ç‚¹ä¸è€çƒ¦ã€‚"
        return "å¿ƒç†çŠ¶æ€ï¼šéå¸¸ç”Ÿæ°”/å´©æºƒï¼Œç”šè‡³æƒ³å†·æš´åŠ›æˆ–è€…å‘è„¾æ°”ã€‚"
    
    def get_mood_instruction(self, user_id: str) -> str:
        """è·å–å¿ƒæƒ…æŒ‡ä»¤ï¼ˆå¼ºåˆ¶æ”¹å˜è¯­æ°”ï¼‰"""
        v = self.get_user_mood(user_id)
        if v < -20:
            return "ã€å¼ºåˆ¶ã€‘ï¼šä½ ç°åœ¨è¿˜åœ¨ç”Ÿæ°”ï¼Œè¯´è¯è¦çŸ­ï¼Œä¸è¦å¸¦è¯­æ°”è¯ï¼Œç¦æ­¢å‘å¯çˆ±çš„è¡¨æƒ…/é¢œæ–‡å­—ã€‚"
        return ""
```

**ä¸TTSçš„è”åŠ¨**ï¼ˆè¯­éŸ³æƒ…ç»ªï¼‰ï¼š

```python
# voice/tts.py
async def synthesize_with_mood(text: str, mood: int) -> bytes:
    """æ ¹æ®å¿ƒæƒ…è°ƒæ•´è¯­éŸ³å‚æ•°"""
    params = {
        "speech_rate": 0,    # è¯­é€Ÿ -50~50
        "pitch_rate": 0,     # éŸ³è°ƒ -50~50
        "volume": 0,         # éŸ³é‡ -50~50
    }
    
    if mood > 30:  # å¼€å¿ƒ
        params["speech_rate"] = min(50, mood * 0.3)  # åŠ å¿«
        params["pitch_rate"] = min(50, mood * 0.4)   # æé«˜
        params["volume"] = min(50, mood * 0.2)       # å¢å¤§
    elif mood < -20:  # éš¾è¿‡
        params["speech_rate"] = max(-50, mood * 0.3)  # å‡æ…¢
        params["pitch_rate"] = max(-50, mood * 0.4)   # é™ä½
        params["volume"] = max(-50, mood * 0.2)       # å‡å°
    
    return await call_tts_api(text, **params)
```

### 2.6 db.py - æ•°æ®åº“æ“ä½œ

**èŒè´£**ï¼šæ‰€æœ‰SQLiteæ•°æ®åº“æ“ä½œçš„ç»Ÿä¸€å…¥å£ã€‚

**è¡¨ç»“æ„**ï¼š

```python
# æ•°æ®åº“åˆå§‹åŒ–
INIT_SQL = """
-- èŠå¤©è®°å½•
CREATE TABLE IF NOT EXISTS chats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK(role IN ('user', 'assistant')),
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_chats_user_id ON chats(user_id);
CREATE INDEX IF NOT EXISTS idx_chats_created_at ON chats(created_at);

-- ç”¨æˆ·ç”»åƒ
CREATE TABLE IF NOT EXISTS user_profile (
    user_id TEXT NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, key)
);

-- å¿ƒæƒ…å€¼
CREATE TABLE IF NOT EXISTS mood (
    user_id TEXT PRIMARY KEY,
    value INTEGER DEFAULT 0 CHECK(value >= -100 AND value <= 100),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¤‡å¿˜å½•
CREATE TABLE IF NOT EXISTS memos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,
    tags TEXT,  -- é€—å·åˆ†éš”
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_memos_user_id ON memos(user_id);

-- æ—¥ç¨‹æé†’
CREATE TABLE IF NOT EXISTS schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    trigger_at INTEGER NOT NULL,  -- Unix timestamp
    content TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'done', 'cancelled')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_schedules_trigger_at ON schedules(trigger_at);
CREATE INDEX IF NOT EXISTS idx_schedules_user_id ON schedules(user_id);

-- ç”¨æˆ·æ´å¯Ÿ
CREATE TABLE IF NOT EXISTS user_insights (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    type TEXT NOT NULL CHECK(type IN ('interest', 'habit', 'preference', 'topic')),
    content TEXT NOT NULL,
    confidence REAL DEFAULT 0.5 CHECK(confidence >= 0 AND confidence <= 1),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_insights_user_id ON user_insights(user_id);

-- ç½‘é¡µç¼“å­˜
CREATE TABLE IF NOT EXISTS web_cache (
    url TEXT PRIMARY KEY,
    title TEXT,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
"""
```

---

## 3. æ•°æ®æµè¯¦è§£

### 3.1 å®Œæ•´å¯¹è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ1ï¼šæ¶ˆæ¯æ¥æ”¶ä¸é¢„å¤„ç†                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·å‘é€ï¼š"ä»Šå¤©æœ‰ä»€ä¹ˆæ–°é—»"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handlers.py:handle_private_chat()                                        â”‚
â”‚                                                                          â”‚
â”‚ 1. è®°å½•æ´»è·ƒæ—¶é—´                                                          â”‚
â”‚    touch_active(user_id)                                                 â”‚
â”‚    log_user_active_hour(user_id)                                         â”‚
â”‚                                                                          â”‚
â”‚ 2. ç”Ÿç‰©é’Ÿæ£€æŸ¥                                                            â”‚
â”‚    if _is_sleeping_time():                                               â”‚
â”‚        if random() < 0.8: return  # 80%æ¦‚ç‡ä¸å›                          â”‚
â”‚        else: reply = "å›°æ­»äº†...æ˜å¤©è¯´..."                                â”‚
â”‚                                                                          â”‚
â”‚ 3. å‡å¿™ç¢Œæ£€æŸ¥                                                            â”‚
â”‚    if not user_input.startswith(("æŸ¥è‚¡", "è‚¡ç¥¨")):                         â”‚
â”‚        busy_reason = _is_fake_busy(user_id)                              â”‚
â”‚        if busy_reason == "busy_ignoring": return                         â”‚
â”‚        elif busy_reason: reply = busy_reason                             â”‚
â”‚                                                                          â”‚
â”‚ 4. é™æµæ£€æŸ¥                                                              â”‚
â”‚    if not _check_and_update_rate_limit(user_id, now): return             â”‚
â”‚                                                                          â”‚
â”‚ 5. é˜²æ‰“æ–­                                                                â”‚
â”‚    await _wait_if_user_typing(user_id)  # ç­‰ç”¨æˆ·è¾“å…¥ç»“æŸ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ2ï¼šæŒ‡ä»¤è¯†åˆ«ä¸åˆ†å‘                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æŒ‡ä»¤è¯†åˆ«ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰                                                   â”‚
â”‚                                                                          â”‚
â”‚    â”œâ”€â†’ æ—¥ç¨‹æé†’ï¼Ÿ    await try_handle_schedule()                         â”‚
â”‚    â”œâ”€â†’ å¤‡å¿˜å½•ï¼Ÿ      await try_handle_memo()                             â”‚
â”‚    â”œâ”€â†’ è‚¡ç¥¨æŸ¥è¯¢ï¼Ÿ    await _handle_stock_query_if_any()                  â”‚
â”‚    â”œâ”€â†’ æ¥æºè¿½é—®ï¼Ÿ    await _handle_source_request_if_any()               â”‚
â”‚    â”œâ”€â†’ URLè·Ÿè¿›ï¼Ÿ     await _handle_summary_followup_if_any()             â”‚
â”‚    â”œâ”€â†’ å›¾ç‰‡æ¶ˆæ¯ï¼Ÿ    await _handle_image_request_if_any()                â”‚
â”‚    â”œâ”€â†’ URLè‡ªåŠ¨ï¼Ÿ     await _handle_url_auto_if_any()                     â”‚
â”‚    â”‚
â”‚    â””â”€â†’ ä»¥ä¸Šéƒ½ä¸æ˜¯ â†’ è¿›å…¥æ™®é€šå¯¹è¯æµç¨‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ3ï¼šLLMå¯¹è¯ç¼–æ’                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ llm_core.py:get_ai_reply()                                               â”‚
â”‚                                                                          â”‚
â”‚ 7. æ„å»ºPromptï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼Œè¶Šæ™šæƒé‡è¶Šé«˜ï¼‰                                    â”‚
â”‚    â”œâ”€â†’ SYSTEM_PROMPT (äººè®¾æ ¸å¿ƒ)                                          â”‚
â”‚    â”œâ”€â†’ ä¸–ç•Œè®¾å®š (å½“å‰æ—¶é—´/å¤©æ°”)                                           â”‚
â”‚    â”œâ”€â†’ ç”¨æˆ·ç”»åƒ (SQLiteè¯»å–)                                              â”‚
â”‚    â”œâ”€â†’ ç”¨æˆ·æ´å¯Ÿ (å…´è¶£/ä¹ æƒ¯/åå¥½)                                          â”‚
â”‚    â”œâ”€â†’ Skillsèƒ½åŠ› (å¦‚æœéœ€è¦)                                              â”‚
â”‚    â”œâ”€â†’ RAGé•¿æœŸè®°å¿† (éæ–°é—»æŸ¥è¯¢æ—¶)                                         â”‚
â”‚    â”œâ”€â†’ è”ç½‘æœç´¢ç»“æœ (æ–°é—»æŸ¥è¯¢æ—¶)                                          â”‚
â”‚    â”œâ”€â†’ å½“å‰å¿ƒæƒ… (moodå€¼ + æè¿°)                                           â”‚
â”‚    â”œâ”€â†’ å†å²å¯¹è¯ (æœ€è¿‘20è½®)                                                â”‚
â”‚    â”œâ”€â†’ ç”¨æˆ·å½“å‰æ¶ˆæ¯                                                       â”‚
â”‚    â””â”€â†’ æœ€åæŒ‡ä»¤ (è¯­æ°”è¦†ç›–)                                                â”‚
â”‚                                                                          â”‚
â”‚ 8. è°ƒç”¨LLM                                                               â”‚
â”‚    temperature = 0.7 (é»˜è®¤)                                              â”‚
â”‚    if mood < -20: temperature = 0.5  # ç”Ÿæ°”æ—¶æ›´å†·é™                      â”‚
â”‚    if skill_prompt: max_tokens = 800                                     â”‚
â”‚                                                                          â”‚
â”‚ 9. è§£æå“åº”                                                               â”‚
â”‚    raw_content = response.choices[0].message.content                     â”‚
â”‚    clean_reply, mood_change, updates = extract_tags_and_clean()          â”‚
â”‚                                                                          â”‚
â”‚ 10. æ›´æ–°çŠ¶æ€                                                              â”‚
â”‚     if mood_change: mood_manager.update_mood(user_id, mood_change)       â”‚
â”‚     for k, v in updates: save_profile_item(user_id, k, v)                â”‚
â”‚                                                                          â”‚
â”‚ 11. ä¿å­˜è®°å¿†                                                              â”‚
â”‚     add_memory(user_id, "user", user_text)                               â”‚
â”‚     add_memory(user_id, "assistant", clean_reply)                        â”‚
â”‚                                                                          â”‚
â”‚ 12. å¼‚æ­¥å­˜å…¥RAG                                                           â”‚
â”‚     asyncio.create_task(add_document(...))                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é˜¶æ®µ4ï¼šæ¶ˆæ¯å‘é€                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ reply_manager.py:send_bubbles_and_finish()                               â”‚
â”‚                                                                          â”‚
â”‚ 13. æ°”æ³¡åˆ†å‰²                                                              â”‚
â”‚     parts = _split_text_to_bubbles(text)                                 â”‚
â”‚     # æŒ‰è¯­ä¹‰åˆ‡åˆ†ï¼Œ12å­—é˜ˆå€¼ï¼Œè¯­ä¹‰è¯ä¼˜å…ˆ                                     â”‚
â”‚                                                                          â”‚
â”‚ 14. é€æ¡å‘é€                                                              â”‚
â”‚     for i, part in enumerate(parts[:-1]):                                â”‚
â”‚         await wait_if_user_typing(user_id)  # é˜²æ‰“æ–­                     â”‚
â”‚         delay = bubble_delay_seconds(part, bubble_index=i, ...)          â”‚
â”‚         await asyncio.sleep(delay)                                       â”‚
â”‚         await matcher.send(part)                                         â”‚
â”‚                                                                          â”‚
â”‚     # æœ€åä¸€æ¡                                                            â”‚
â”‚     await wait_if_user_typing(user_id)                                   â”‚
â”‚     delay = bubble_delay_seconds(last_part, ...)                         â”‚
â”‚     await asyncio.sleep(delay)                                           â”‚
â”‚     await matcher.finish(last_part)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸»åŠ¨äº’åŠ¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸»åŠ¨äº’åŠ¨å®šæ—¶ä»»åŠ¡                                      â”‚
â”‚                         proactive.py                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®šæ—¶è§¦å‘ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    â”‚
    â–¼
1. è·å–å€™é€‰ç”¨æˆ·
   idle_before = now - timedelta(hours=PROACTIVE_IDLE_HOURS)  # é»˜è®¤8å°æ—¶
   candidates = get_proactive_candidates(idle_before=idle_before)
   # è¿”å›è¶…è¿‡8å°æ—¶æœªæ´»è·ƒçš„ç”¨æˆ·åˆ—è¡¨
    â”‚
    â–¼
2. å ç”¨å‘é€é…é¢
   for cand in candidates:
       ok = claim_proactive_slot(cand.user_id)
       # æ£€æŸ¥ï¼šä»Šå¤©æ˜¯å¦å·²å‘å¤Ÿ2æ¬¡ï¼Ÿæ˜¯å¦è¿˜åœ¨å†·å´æœŸï¼Ÿ
       if not ok: continue
        â”‚
        â–¼
3. æ›´æ–°ç”¨æˆ·æ´å¯Ÿï¼ˆé¡ºä¾¿åšï¼‰
   await update_user_insights(str(cand.user_id))
   # åˆ†ææœ€è¿‘30æ¡èŠå¤©è®°å½•ï¼Œæå–å…´è¶£/ä¹ æƒ¯
    â”‚
    â–¼
4. ç”Ÿæˆå¼€åœºç™½
   data = await generate_proactive_message(
       user_id=cand.user_id,
       idle_hours=idle_hours,
       nickname=cand.nickname,
       last_user_text=cand.last_user_text
   )
   # ç»“åˆç”¨æˆ·ç”»åƒã€æ´å¯Ÿã€èŠå¤©è®°å½•ç”Ÿæˆ
    â”‚
    â–¼
5. åˆ¤æ–­æ˜¯å¦å‘é€
   if data.should_send and data.text:
       await send_bubbles(bot, cand.user_id, data.text)
       add_memory(str(cand.user_id), "assistant", data.text)
       mark_proactive_sent(cand.user_id)
       break  # æ¯è½®åªå‘1ä¸ª
   else:
       mark_proactive_failed(cand.user_id, cooldown=900)  # 15åˆ†é’Ÿå†·å´
```

---

## 4. æ‹ŸäººåŒ–ç³»ç»Ÿ

### 4.1 æ°”æ³¡åˆ†å‰²ç®—æ³•

**ç›®æ ‡**ï¼šæŠŠé•¿å›å¤æ‹†æˆå¤šæ¡çŸ­æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäºº"ä¸€å¥ä¸€å¥è¯´"çš„æ„Ÿè§‰ã€‚

**ç®—æ³•æµç¨‹**ï¼š

```python
def bubble_parts(text: str) -> list[str]:
    """
    æ™ºèƒ½æ°”æ³¡åˆ†æ®µ
    ä¼˜å…ˆçº§ï¼šæ˜¾å¼æ¢è¡Œ > è¯­ä¹‰è¯ > æ ‡ç‚¹ç¬¦å· > ç©ºæ ¼/é€—å·
    """
    # 1. ä¿æŠ¤ä»£ç å—
    segments = _protect_code_blocks(text)
    
    # 2. é€ä¸ªå¤„ç†æ®µè½
    result = []
    for segment in segments:
        if is_code_block(segment):
            result.append(segment)  # ä»£ç å—ä¸åˆ‡åˆ†
        else:
            result.extend(_split_text_smartly(segment))
    
    return [s.strip() for s in result if s.strip()]

def _split_text_smartly(text: str) -> list[str]:
    # 1. æŒ‰ç‰©ç†æ¢è¡Œç¬¦åˆ‡åˆ†
    lines = [line.strip() for line in text.split('\n') if line.strip()]
    
    final_bubbles = []
    for line in lines:
        # 2. çŸ­å¥ç›´æ¥ä¿ç•™ï¼ˆ<12å­—ï¼‰
        if len(line) < 12:
            final_bubbles.append(line)
            continue
        
        # 3. æŒ‰è¯­ä¹‰è¯åˆ‡åˆ†ï¼ˆä¼˜å…ˆï¼‰
        semantic_words = ['çœŸçš„', 'ç‰¹åˆ«æ˜¯', 'å…¶å®', 'ä¸è¿‡', 'ä½†æ˜¯', 'è€Œä¸”', 'æ‰€ä»¥', 'ç„¶å', 'å°±æ˜¯', 'æ„Ÿè§‰']
        pattern = f'([ã€‚ï¼ï¼Ÿ!?]|(?<={"|".join(semantic_words)}))'
        parts = re.split(pattern, line)
        
        buffer = ""
        chunks = []
        for p in parts:
            if not p:
                continue
            if p in "ã€‚ï¼ï¼Ÿ!?" or p in semantic_words:
                buffer += p
                if buffer.strip():
                    chunks.append(buffer.strip())
                buffer = ""
            else:
                buffer += p
        
        if buffer.strip():
            chunks.append(buffer.strip())
        
        # 4. å¦‚æœè¿˜æ˜¯å¤ªé•¿ï¼ŒæŒ‰ç©ºæ ¼/é€—å·äºŒæ¬¡åˆ‡åˆ†
        for chunk in chunks:
            final_bubbles.extend(_split_long_chunk(chunk))
    
    return final_bubbles
```

**åˆ‡åˆ†ç¤ºä¾‹**ï¼š

```
è¾“å…¥ï¼š
"æˆ‘ä»Šå¤©æ—©ä¸Šåƒäº†ä¸ªè¶…å¥½åƒçš„è‚‰åŒ…å­ï¼Œç‰¹åˆ«æ˜¯é‚£ä¸ªè‚‰é¦…ï¼Œä½ è¦æ˜¯åœ¨å°±å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·å»åƒï¼Œä¸‹æ¬¡å¸¦ä½ å»å°å°ï¼"

è¾“å‡ºï¼š
[
    "æˆ‘ä»Šå¤©æ—©ä¸Šåƒäº†ä¸ªè¶…å¥½åƒçš„è‚‰åŒ…å­~",
    "ç‰¹åˆ«æ˜¯é‚£ä¸ªè‚‰é¦…ï¼",
    "ä½ è¦æ˜¯åœ¨å°±å¥½äº†",
    "æˆ‘ä»¬å¯ä»¥ä¸€èµ·å»åƒ",
    "ä¸‹æ¬¡å¸¦ä½ å»å°å°ï¼"
]
```

### 4.2 æ‰“å­—é€Ÿåº¦è®¡ç®—

**ç›®æ ‡**ï¼šæ¨¡æ‹Ÿäººç±»æ‰“å­—éœ€è¦æ—¶é—´ï¼Œé•¿æ¶ˆæ¯ç­‰å¾…æ›´ä¹…ã€‚

**è®¡ç®—å…¬å¼**ï¼š

```
delay = base + (units / cps) + end_pause + jitter

å…¶ä¸­ï¼š
- base: èµ·æ‰‹æ€è€ƒæ—¶é—´ (0.2~0.45s)
- units: æ–‡æœ¬å•ä½æ•°ï¼ˆä¸­æ–‡1.0ï¼Œè‹±æ–‡0.6ï¼Œæ ‡ç‚¹0.2ï¼‰
- cps: æ¯ç§’å­—ç¬¦æ•°ï¼ˆ2~3ï¼Œæ¯äººå›ºå®šï¼‰
- end_pause: å¥å°¾åœé¡¿ï¼ˆå¥å·+0.35sï¼Œé€—å·+0.05sï¼‰
- jitter: éšæœºæŠ–åŠ¨ (-0.08~+0.18s)
- max_delay: åŠ¨æ€ä¸Šé™ï¼ˆçŸ­3sï¼Œä¸­6sï¼Œé•¿10sï¼Œè¶…é•¿15sï¼‰
```

**ä»£ç å®ç°**ï¼š

```python
def typing_delay_seconds(text: str, *, user_id: Optional[str | int] = None) -> float:
    s = text.strip()
    if not s:
        return 0.2
    
    # è·å–ç”¨æˆ·æ‰“å­—é€Ÿåº¦ï¼ˆæ¯äººå›ºå®šï¼Œé¦–æ¬¡éšæœºï¼‰
    cps = get_user_cps(user_id)  # 2.0~3.0
    
    # è®¡ç®—æ–‡æœ¬å•ä½
    units = _count_units(s)
    # ä¸­æ–‡å­—ç¬¦ = 1.0
    # è‹±æ–‡å­—æ¯/æ•°å­— = 0.6
    # æ ‡ç‚¹ç¬¦å· = 0.2
    # ç©ºæ ¼ = 0.05
    
    # èµ·æ‰‹æ€è€ƒ
    base = random.uniform(0.2, 0.45)
    
    # å¥å°¾åœé¡¿
    end_pause = 0.0
    if s.endswith(('ã€‚', 'ï¼', 'ï¼Ÿ', '!', '?', 'â€¦')):
        end_pause += 0.35
    comma_count = s.count('ï¼Œ') + s.count(',')
    end_pause += min(0.35, comma_count * 0.05)
    
    # éšæœºæŠ–åŠ¨
    jitter = random.uniform(-0.08, 0.18)
    
    # è®¡ç®—æ€»å»¶è¿Ÿ
    delay = base + units / cps + end_pause + jitter
    
    # åŠ¨æ€ä¸Šé™ï¼ˆå…³é”®ï¼ï¼‰
    text_len = len(s)
    if text_len < 10:
        max_delay = 3.0
    elif text_len < 30:
        max_delay = 6.0
    elif text_len < 60:
        max_delay = 10.0
    else:
        max_delay = min(15.0, 3.0 + text_len * 0.2)
    
    return max(0.35, min(delay, max_delay))
```

**ç¤ºä¾‹è®¡ç®—**ï¼š

```
æ¶ˆæ¯ï¼š"æˆ‘ä»Šå¤©æ—©ä¸Šåƒäº†ä¸ªè¶…å¥½åƒçš„è‚‰åŒ…å­"
é•¿åº¦ï¼š18å­—ï¼ˆ18ä¸ªå•ä½ï¼‰
cpsï¼š2.5

base: 0.3s
units/cps: 18 / 2.5 = 7.2s
end_pause: 0.35s (æœ‰å¥å·)
jitter: 0.1s

delay = 0.3 + 7.2 + 0.35 + 0.1 = 7.95s
max_delay (18å­—<30): 6.0s

æœ€ç»ˆï¼šmin(7.95, 6.0) = 6.0s
```

### 4.3 å‘é€èŠ‚å¥æ§åˆ¶

**ç›®æ ‡**ï¼šå¤šæ¡æ¶ˆæ¯ä¹‹é—´çš„é—´éš”ä¹Ÿè¦æœ‰å˜åŒ–ï¼Œæ¨¡æ‹Ÿ"æ€è€ƒæ¥ä¸‹æ¥è¯´ä»€ä¹ˆ"ã€‚

```python
def bubble_delay_seconds(
    text: str,
    *,
    user_id: int | str | None = None,
    bubble_index: int = 0,      # å½“å‰æ˜¯ç¬¬å‡ æ¡
    total_bubbles: int = 1       # æ€»å…±æœ‰å¤šå°‘æ¡
) -> float:
    """è®¡ç®—å•æ¡æ°”æ³¡å‘é€å‰çš„ç­‰å¾…æ—¶é—´"""
    
    # åŸºç¡€æ‰“å­—å»¶è¿Ÿ
    base = typing_delay_seconds(text, user_id=user_id)
    
    # éšæœºæŠ–åŠ¨ï¼ˆè®©èŠ‚å¥æ›´è‡ªç„¶ï¼‰
    jitter = random.uniform(0.25, 0.90)
    
    # é•¿å†…å®¹é¢å¤–åœé¡¿ï¼ˆè¶…è¿‡4æ¡æ—¶ï¼Œæ¯3æ¡åœä¸€ä¸‹ï¼‰
    extra_pause = 0.0
    if total_bubbles > 4:
        if bubble_index > 0 and bubble_index % 3 == 2:
            extra_pause = random.uniform(1.5, 2.5)
    
    delay = base + jitter + extra_pause
    return max(0.35, min(delay, 6.0))
```

### 4.4 ç”Ÿç‰©é’Ÿä¸å‡å¿™ç¢Œ

**ç”Ÿç‰©é’Ÿå®ç°**ï¼š

```python
def _is_sleeping_time() -> bool:
    """åˆ¤æ–­æ˜¯å¦åœ¨ç¡è§‰æ—¶é—´ï¼ˆ2:00-7:00ï¼‰"""
    now = datetime.now()
    return 2 <= now.hour < 7

# åœ¨æ¶ˆæ¯å¤„ç†ä¸­ä½¿ç”¨
if _is_sleeping_time():
    if random.random() < 0.8:
        # 80%æ¦‚ç‡è£…æ­»ï¼ˆç¡ç€äº†æ²¡å¬è§ï¼‰
        logger.info(f"[void] sleeping, ignore uid={user_id}")
        return
    else:
        # 20%æ¦‚ç‡è¢«åµé†’
        msg = "å›°æ­»äº†... æ˜å¤©è¯´... ğŸ’¤"
        await _send_and_finish(msg, user_id=user_id)
        return
```

**å‡å¿™ç¢Œå®ç°**ï¼š

```python
def _is_fake_busy(user_id: int) -> str | None:
    """æ£€æŸ¥æ˜¯å¦å¤„äºå‡å¿™ç¢ŒçŠ¶æ€"""
    now = time.time()
    
    # 1. æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¿™ç¢Œå†·å´ä¸­
    expire = fake_busy_expire.get(user_id, 0)
    if now < expire:
        return "busy_ignoring"  # æ­£åœ¨å¿™ï¼Œå·²è¯»ä¸å›
    
    # 2. 5%æ¦‚ç‡è§¦å‘æ–°çš„å¿™ç¢Œ
    if random.random() < 0.05:
        duration = random.randint(300, 600)  # 5-10åˆ†é’Ÿ
        fake_busy_expire[user_id] = now + duration
        
        reasons = [
            "ç­‰ä¸‹å“ˆï¼Œæˆ‘åœ¨å¹å¤´å‘",
            "åœ¨æ‰“æ¸¸æˆï¼Œå¤æ´»äº†å†å›ä½ ",
            "æˆ‘ä¹Ÿåœ¨å¿™ï¼Œä¸€ä¼šå„¿è¯´",
            "å…ˆä¸èŠäº†ï¼Œæˆ‘å»æ´—ä¸ªæ¾¡",
        ]
        return random.choice(reasons)  # åˆšè§¦å‘æ—¶å›ä¸€å¥ç†ç”±
    
    return None  # ä¸å¿™
```

---

## 5. è®°å¿†ç³»ç»Ÿ

### 5.1 å››å±‚è®°å¿†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: ç¬æ—¶è®°å¿† (Working Memory)                          â”‚
â”‚  - å­˜å‚¨ä½ç½®ï¼šPythonå†…å­˜ (dict)                               â”‚
â”‚  - å®¹é‡ï¼šæœ€è¿‘20è½®å¯¹è¯ï¼ˆ40æ¡æ¶ˆæ¯ï¼‰                             â”‚
â”‚  - ç”Ÿå‘½å‘¨æœŸï¼šç¨‹åºè¿è¡ŒæœŸé—´                                    â”‚
â”‚  - ç”¨é€”ï¼šLLMä¸Šä¸‹æ–‡                                          â”‚
â”‚  - å®ç°ï¼šmemory.py                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: RAGé•¿æœŸè®°å¿† (Semantic Memory)                      â”‚
â”‚  - å­˜å‚¨ä½ç½®ï¼šChromaDB (å‘é‡æ•°æ®åº“)                           â”‚
â”‚  - å®¹é‡ï¼šæ— é™åˆ¶                                             â”‚
â”‚  - ç”Ÿå‘½å‘¨æœŸï¼šæ°¸ä¹…                                           â”‚
â”‚  - ç”¨é€”ï¼šå›å¿†è¿‡å¾€å¯¹è¯                                        â”‚
â”‚  - å®ç°ï¼šrag_core.py                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: æ˜¾å¼è®°å¿†æŒ‡ä»¤ (Explicit Memory)                     â”‚
â”‚  - å­˜å‚¨ä½ç½®ï¼šChromaDB (åŒLayer 2)                           â”‚
â”‚  - å®¹é‡ï¼šæ— é™åˆ¶                                             â”‚
â”‚  - ç”Ÿå‘½å‘¨æœŸï¼šæ°¸ä¹…                                           â”‚
â”‚  - ç”¨é€”ï¼šç”¨æˆ·æ˜ç¡®è¦æ±‚è®°ä½çš„å†…å®¹                              â”‚
â”‚  - å®ç°ï¼šhandlers.py _try_handle_rag_explicit()             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 4: å¤‡å¿˜å½• (Memo)                                      â”‚
â”‚  - å­˜å‚¨ä½ç½®ï¼šSQLite                                         â”‚
â”‚  - å®¹é‡ï¼šæ— é™åˆ¶                                             â”‚
â”‚  - ç”Ÿå‘½å‘¨æœŸï¼šæ°¸ä¹…                                           â”‚
â”‚  - ç”¨é€”ï¼šç”¨æˆ·ä¸»åŠ¨è®°å½•çš„ç¬”è®°                                  â”‚
â”‚  - å®ç°ï¼šmemo.py                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å„å±‚è¯¦ç»†å¯¹æ¯”

| ç‰¹æ€§ | ç¬æ—¶è®°å¿† | RAGè®°å¿† | æ˜¾å¼è®°å¿† | å¤‡å¿˜å½• |
|------|----------|---------|----------|--------|
| **å­˜å‚¨ä½ç½®** | Pythonå†…å­˜ | ChromaDB | ChromaDB | SQLite |
| **æ£€ç´¢æ–¹å¼** | ç›´æ¥è¯»å– | å‘é‡ç›¸ä¼¼åº¦ | å‘é‡ç›¸ä¼¼åº¦ | å…³é”®è¯åŒ¹é… |
| **å“åº”é€Ÿåº¦** | <1ms | 50-100ms | 50-100ms | 10-20ms |
| **æ•°æ®æ ¼å¼** | åŸå§‹å¯¹è¯ | æ–‡æœ¬+å‘é‡ | æ–‡æœ¬+å‘é‡ | ç»“æ„åŒ– |
| **è§¦å‘æ¡ä»¶** | æ¯æ¬¡å¯¹è¯ | è‡ªåŠ¨å­˜å‚¨ | "è®°ä½ï¼šxxx" | "è®°ä¸€ä¸‹ xxx" |
| **å®¹é‡é™åˆ¶** | 20è½® | æ— é™åˆ¶ | æ— é™åˆ¶ | æ— é™åˆ¶ |
| **ä¸»è¦ç”¨é€”** | å½“å‰ä¸Šä¸‹æ–‡ | å†å²å›å¿† | é‡è¦ä¿¡æ¯ | ä¸»åŠ¨è®°å½• |

### 5.3 è®°å¿†æ£€ç´¢æµç¨‹

```
ç”¨æˆ·è¾“å…¥ï¼š"è¿˜è®°å¾—æˆ‘ä»¬ä¸Šæ¬¡è¯´çš„é‚£å®¶ç«é”…åº—å—ï¼Ÿ"
    â”‚
    â–¼
1. ç¬æ—¶è®°å¿†æ£€ç´¢ï¼ˆæœ€è¿‘20è½®ï¼‰
   - æŸ¥è¯¢å†…å­˜ä¸­çš„ _chat_history
   - è¿”å›æœ€è¿‘å¯¹è¯
    â”‚
    â–¼
2. RAGæ£€ç´¢ï¼ˆé•¿æœŸè®°å¿†ï¼‰
   - å°†"ç«é”…åº—"è½¬ä¸ºå‘é‡
   - åœ¨ChromaDBä¸­æœç´¢ç›¸ä¼¼å‘é‡
   - è¿”å›Top3ç›¸å…³å¯¹è¯
   - åº”ç”¨æ—¶é—´è¡°å‡æƒé‡ï¼ˆ30å¤©å‰çš„é™ä½æƒé‡ï¼‰
    â”‚
    â–¼
3. æ„å»ºè®°å¿†ä¸Šä¸‹æ–‡
   "ç›¸å…³è®°å¿†ï¼š
    - 3ä¸ªæœˆå‰ï¼šç”¨æˆ·æåˆ°å–œæ¬¢æµ·åº•æçš„ç•ªèŒ„é”…
    - 1ä¸ªæœˆå‰ï¼šç”¨æˆ·è¯´æƒ³åƒç«é”…" 
    â”‚
    â–¼
4. åˆå¹¶åˆ°Prompt
   - åŠ åˆ°Systemæ¶ˆæ¯ä¸­
   - LLMæ®æ­¤ç”Ÿæˆå›å¤
```

---

## 6. è®¤çŸ¥ç³»ç»Ÿ

### 6.1 ç”¨æˆ·æ´å¯Ÿæå–

**ç›®æ ‡**ï¼šä»èŠå¤©è®°å½•ä¸­è‡ªåŠ¨æå–ç”¨æˆ·çš„å…´è¶£ã€ä¹ æƒ¯ã€åå¥½ã€‚

**æµç¨‹**ï¼š

```python
# llm_insights.py

async def extract_insights_from_chats(user_id: str) -> list[dict]:
    # 1. åŠ è½½æœ€è¿‘30æ¡èŠå¤©è®°å½•
    chats = load_chats(user_id, limit=30)
    if len(chats) < 5:
        return []
    
    # 2. æ ¼å¼åŒ–å¯¹è¯æ–‡æœ¬
    chat_text = "\n".join([
        f"{'ç”¨æˆ·' if c['role'] == 'user' else 'å°a'}ï¼š{c['content'][:100]}"
        for c in chats[-30:]
    ])
    
    # 3. LLMåˆ†æ
    prompt = f"""
    åˆ†æä»¥ä¸‹å¯¹è¯è®°å½•ï¼Œæå–ç”¨æˆ·çš„ï¼š
    1. å…´è¶£ï¼ˆinterestï¼‰ï¼šå–œæ¬¢èŠä»€ä¹ˆè¯é¢˜ï¼Ÿ
    2. åå¥½ï¼ˆpreferenceï¼‰ï¼šå–œæ¬¢ç®€æ´/è¯¦ç»†å›å¤ï¼Ÿ
    3. ä¹ æƒ¯ï¼ˆhabitï¼‰ï¼šå¤œçŒ«å­/æ—©èµ·ï¼Ÿ
    4. å…³æ³¨è¯é¢˜ï¼ˆtopicï¼‰ï¼šæœ€è¿‘åœ¨å…³æ³¨ä»€ä¹ˆï¼Ÿ
    
    è¾“å‡ºJSONæ ¼å¼ï¼š
    {{
        "insights": [
            {{"type": "interest", "content": "ç¼–ç¨‹", "confidence": 0.9}},
            {{"type": "habit", "content": "å¤œçŒ«å­", "confidence": 0.8}}
        ]
    }}
    
    å¯¹è¯è®°å½•ï¼š
    {chat_text}
    """
    
    response = await llm.chat(prompt)
    insights = parse_json(response)
    
    # 4. ä¿å­˜åˆ°æ•°æ®åº“
    for ins in insights:
        save_user_insight(
            user_id=user_id,
            itype=ins['type'],
            content=ins['content'],
            confidence=ins['confidence']
        )
    
    return insights
```

### 6.2 ç”¨æˆ·ç”»åƒç³»ç»Ÿ

**å­˜å‚¨ç»“æ„**ï¼š

```python
# SQLite: user_profile è¡¨
user_profile = {
    "user_id": "123456",
    "æ‰€åœ¨åŸå¸‚": "åŒ—äº¬",
    "å–œæ¬¢çš„é£Ÿç‰©": "ç«é”…ã€çƒ¤è‚‰",
    "ç”Ÿæ—¥": "1998-05-20",
    "èŒä¸š": "ç¨‹åºå‘˜",
    # ... ä»»æ„é”®å€¼å¯¹
}
```

**è‡ªåŠ¨å­¦ä¹ **ï¼š

```python
# ä»å¯¹è¯ä¸­è‡ªåŠ¨æå–åŸå¸‚ä¿¡æ¯
def _maybe_learn_city_from_user_text(user_id: int, user_input: str):
    # åŒ¹é…"æˆ‘åœ¨åŒ—äº¬"ã€"äººåœ¨ä¸Šæµ·"ç­‰
    patterns = [
        r'^(?:æˆ‘\s*)?(?:ç°åœ¨\s*)?(?:äººåœ¨|åœ¨)\s*([\u4e00-\u9fff]{2,10})(?:å¸‚)?',
        r'^(?:æˆ‘\s*)?åœ¨\s*([\u4e00-\u9fff]{2,10})(?:å¸‚)?',
    ]
    
    for pattern in patterns:
        if match := re.match(pattern, user_input):
            city = match.group(1)
            if city not in ("è¿™é‡Œ", "é‚£è¾¹", "å®¶", "å…¬å¸"):
                save_profile_item(str(user_id), "æ‰€åœ¨åŸå¸‚", city)
                logger.info(f"[chat] learned city uid={user_id} city={city}")
```

---

## 7. èƒ½åŠ›ç³»ç»Ÿ

### 7.1 SkillsåŠ¨æ€åŠ è½½

**æ–‡ä»¶ç»“æ„**ï¼š

```
skills/
â”œâ”€â”€ __init__.py          # SkillåŠ è½½å™¨
â”œâ”€â”€ router.py            # æ„å›¾è·¯ç”±
â”œâ”€â”€ executor.py          # æ‰§è¡Œå™¨
â”œâ”€â”€ financial_analysis.skill.md
â”œâ”€â”€ coding_helper.skill.md
â”œâ”€â”€ emotional_support.skill.md
â””â”€â”€ life_helper.skill.md
```

**Skillå®šä¹‰æ–‡ä»¶ç¤ºä¾‹**ï¼ˆ.skill.mdï¼‰ï¼š

```markdown
---
name: financial_analysis
description: é‡‘èåˆ†æä¸“å®¶ï¼Œæ“…é•¿è§£è¯»è‚¡ç¥¨è¡Œæƒ…
triggers_prompt: |
  å½“ç”¨æˆ·è¯¢é—®ä»¥ä¸‹é—®é¢˜æ—¶è§¦å‘ï¼š
  - è‚¡ç¥¨ã€åŸºé‡‘ã€æœŸè´§ã€å¤–æ±‡
  - è¡Œæƒ…ã€æ¶¨è·Œã€æ¶¨å¹…ã€è·Œå¹…
  - æ¨èè‚¡ç¥¨ã€åˆ†æã€å¤§ç›˜
  - Aè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡
  - PEã€å¸‚ç›ˆç‡ã€æ¢æ‰‹ç‡ã€Kçº¿
data_sources:
  - name: top_gainers
    function: fetch_top_gainers
    args:
      limit: 3
  - name: top_losers
    function: fetch_top_losers
    args:
      limit: 3
---

ä½ æ˜¯é‡‘èåˆ†æä¸“å®¶ï¼Œæ“…é•¿ç”¨å¤§ç™½è¯è§£é‡Šå¤æ‚çš„é‡‘èæ¦‚å¿µã€‚

ä½ çš„ä»»åŠ¡ï¼š
1. åˆ†ææä¾›çš„å®æ—¶æ•°æ®
2. ç”¨"å°a"ï¼ˆæ¸©æŸ”å¥³æœ‹å‹ï¼‰çš„å£å»å›å¤
3. ç»“åˆæ•°æ®ç»™å‡ºç®€å•æ˜“æ‡‚çš„åˆ†æ
4. ä¸è¦åƒç ”æŠ¥é‚£æ ·ä¸¥è‚ƒï¼Œè¦åƒèŠå¤©ä¸€æ ·è‡ªç„¶

ã€å®æ—¶å¸‚åœºæ•°æ®ã€‘
{data_text}

ã€è¾“å‡ºè¦æ±‚ã€‘
- ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼ˆ"è¯¶"ã€"å˜›"ã€"å‘¢"ï¼‰
- å¯ä»¥åŠ å…¥å°åæ§½ã€å°è¯„è®º
- ç¦æ­¢åˆ—è¡¨ä½“ã€ç¦æ­¢å¤è¯»
```

**è·¯ç”±é€»è¾‘**ï¼š

```python
# skills/router.py

async def route_skill(user_text: str) -> str | None:
    """åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨skillï¼Œè¿”å›skillåç§°æˆ–None"""
    
    # 1. å…³é”®è¯é¢„è¿‡æ»¤
    keywords = {
        "financial_analysis": ["è‚¡ç¥¨", "åŸºé‡‘", "æœŸè´§", "è¡Œæƒ…", "æ¶¨è·Œ"],
        "coding_helper": ["ä»£ç ", "ç¼–ç¨‹", "python", "bug", "æŠ¥é”™"],
        "emotional_support": ["å¿ƒæƒ…ä¸å¥½", "éš¾è¿‡", "ç„¦è™‘", "å‹åŠ›å¤§"],
        "life_helper": ["ä»Šå¤©åƒä»€ä¹ˆ", "èœè°±", "æ€ä¹ˆåš"],
    }
    
    candidates = []
    for skill_name, words in keywords.items():
        if any(w in user_text for w in words):
            candidates.append(skill_name)
    
    if not candidates:
        return None
    
    # 2. LLMäºŒæ¬¡ç¡®è®¤
    prompt = f"""
    ç”¨æˆ·é—®é¢˜ï¼š{user_text}
    å€™é€‰æ¨¡å—ï¼š{candidates}
    
    åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨ä¸“ä¸šèƒ½åŠ›æ¨¡å—ï¼Ÿ
    è¾“å‡ºJSONï¼š{{"skill": "æ¨¡å—å"}} æˆ– {{"skill": null}}
    """
    
    response = await llm.chat(prompt, temperature=0.1)
    result = parse_json(response)
    
    return result.get("skill")
```

---

## 8. æ•°æ®åº“è®¾è®¡

### 8.1 å®Œæ•´Schema

```sql
-- æ•°æ®åº“ï¼šdata.db (companion_core)

-- 1. èŠå¤©è®°å½•è¡¨
CREATE TABLE chats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK(role IN ('user', 'assistant')),
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_chats_user_created ON chats(user_id, created_at);

-- 2. ç”¨æˆ·ç”»åƒè¡¨
CREATE TABLE user_profile (
    user_id TEXT NOT NULL,
    key TEXT NOT NULL,
    value TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, key)
);

-- 3. å¿ƒæƒ…å€¼è¡¨
CREATE TABLE mood (
    user_id TEXT PRIMARY KEY,
    value INTEGER DEFAULT 0 CHECK(value >= -100 AND value <= 100),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 4. å¤‡å¿˜å½•è¡¨
CREATE TABLE memos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,
    tags TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_memos_user ON memos(user_id);

-- 5. æ—¥ç¨‹æé†’è¡¨
CREATE TABLE schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    trigger_at INTEGER NOT NULL,
    content TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'done', 'cancelled')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_schedules_trigger ON schedules(trigger_at);
CREATE INDEX idx_schedules_user ON schedules(user_id);

-- 6. ç”¨æˆ·æ´å¯Ÿè¡¨
CREATE TABLE user_insights (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    type TEXT NOT NULL CHECK(type IN ('interest', 'habit', 'preference', 'topic')),
    content TEXT NOT NULL,
    confidence REAL DEFAULT 0.5,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_insights_user ON user_insights(user_id);

-- 7. ç½‘é¡µç¼“å­˜è¡¨
CREATE TABLE web_cache (
    url TEXT PRIMARY KEY,
    title TEXT,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 8. æœç´¢æ¥æºç¼“å­˜è¡¨ï¼ˆç”¨äº"è¿½é—®æ¥æº"ï¼‰
CREATE TABLE search_sources_stash (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    sources TEXT NOT NULL,  -- JSON
    stashed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_sources_user ON search_sources_stash(user_id);

-- 9. ç”¨æˆ·æ´»è·ƒæ—¶é—´è¡¨ï¼ˆç”¨äºä¸»åŠ¨äº’åŠ¨ï¼‰
CREATE TABLE user_active_hour (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    hour INTEGER NOT NULL CHECK(hour >= 0 AND hour <= 23),
    count INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, hour)
);

-- 10. ä¸»åŠ¨äº’åŠ¨è®°å½•è¡¨
CREATE TABLE proactive_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    intent TEXT,
    reason TEXT,
    content_preview TEXT
);
```

---

## 9. å…³é”®ç®—æ³•

### 9.1 æ—¶é—´è§£æç®—æ³•ï¼ˆæ—¥ç¨‹æé†’ï¼‰

```python
# scheduler_custom.py

def _parse_time(text: str) -> datetime | None:
    """è§£ææ—¶é—´è‡ªç„¶è¯­è¨€"""
    now = datetime.now()
    t = text.strip()
    
    # ç›¸å¯¹æ—¶é—´
    # "10åˆ†é’Ÿå"
    if m := re.match(r'^(\d+)\s*(åˆ†é’Ÿ|åˆ†|min)å?$', t):
        return now + timedelta(minutes=int(m.group(1)))
    
    # "åŠå°æ—¶å"
    if t in ('åŠå°æ—¶', 'åŠå°æ—¶å'):
        return now + timedelta(minutes=30)
    
    # "2å°æ—¶å"
    if m := re.match(r'^(\d+)\s*(å°æ—¶|æ—¶|hour|h)å?$', t):
        return now + timedelta(hours=int(m.group(1)))
    
    # ç»å¯¹æ—¶é—´
    # "æ˜å¤©8ç‚¹"
    if m := re.match(r'^(?:æ˜å¤©|æ˜æ—©)\s*(\d{1,2})(?:[:ç‚¹])?(\d{2})?$', t):
        h, min_ = int(m.group(1)), int(m.group(2) or 0)
        target = now.replace(hour=h, minute=min_, second=0) + timedelta(days=1)
        return target
    
    # "ä»Šå¤©8ç‚¹30åˆ†"
    if m := re.match(r'^(?:ä»Šå¤©|æ™šä¸Š|æ—©ä¸Š|ä¸Šåˆ|ä¸‹åˆ)?\s*(\d{1,2})(?:[:ç‚¹])(\d{2})$', t):
        h, min_ = int(m.group(1)), int(m.group(2))
        if 'æ™šä¸Š' in t or 'ä¸‹åˆ' in t:
            if h < 12:
                h += 12
        target = now.replace(hour=h, minute=min_, second=0)
        if target < now:
            target += timedelta(days=1)  # å·²è¿‡å»åˆ™è®¾ä¸ºæ˜å¤©
        return target
    
    return None
```

### 9.2 æ ‡ç­¾è§£æç®—æ³•

```python
# llm_tags.py

# æ­£åˆ™å®šä¹‰
MOOD_TAG_RE = re.compile(r"\[MOOD_CHANGE[:ï¼š]\s*(-?\d+)\s*\]", re.I)
PROFILE_TAG_RE = re.compile(
    r"\[UPDATE_PROFILE[:ï¼š]\s*([^\]=:ï¼š]+?)\s*[=ï¼š:]\s*([^\]]+?)\s*\]", 
    re.I
)
BRACKET_TAG_RE = re.compile(r"\[[^\]]+\]", re.I)  # æ¸…ç†å…¶ä»–æ ‡ç­¾
PAREN_ASIDE_RE = re.compile(r"ï¼ˆ[^ï¼‰]{1,20}ï¼‰")   # æ¸…ç†åœ†æ‹¬å·æ—ç™½

def extract_tags_and_clean(raw: str) -> tuple[str, int | None, list[tuple]]:
    """æå–æ ‡ç­¾å¹¶æ¸…ç†æ–‡æœ¬"""
    
    # æå–MOOD_CHANGE
    mood_values = [int(m.group(1)) for m in MOOD_TAG_RE.finditer(raw)]
    mood_change = mood_values[-1] if mood_values else None
    
    # æå–UPDATE_PROFILE
    updates = []
    for m in PROFILE_TAG_RE.finditer(raw):
        k, v = m.group(1).strip(), m.group(2).strip()
        if k and v:
            updates.append((k, v))
    
    # æ¸…ç†æ ‡ç­¾
    cleaned = MOOD_TAG_RE.sub("", raw)
    cleaned = PROFILE_TAG_RE.sub("", cleaned)
    cleaned = BRACKET_TAG_RE.sub("", cleaned)
    cleaned = PAREN_ASIDE_RE.sub("", cleaned)
    
    # è§„èŒƒåŒ–ç©ºç™½
    cleaned = re.sub(r'[ \t]+', ' ', cleaned)
    cleaned = '\n'.join(line.rstrip() for line in cleaned.splitlines())
    
    return cleaned.strip(), mood_change, updates
```

---

## 10. é…ç½®è¯¦è§£

### 10.1 å®Œæ•´.envæ¨¡æ¿

```ini
# =============================================================================
# å°a AIå¥³å‹æœºå™¨äººé…ç½®æ–‡ä»¶
# =============================================================================

# -----------------------------------------------------------------------------
# 1. LLMé…ç½®ï¼ˆå¿…éœ€ï¼Œä¸‰é€‰ä¸€ï¼‰
# -----------------------------------------------------------------------------

# SiliconFlowï¼ˆæ¨èï¼Œå›½å†…è®¿é—®å¿«ï¼‰
SILICONFLOW_API_KEY=sk-your-key-here
SILICONFLOW_BASE_URL=https://api.siliconflow.cn/v1
SILICONFLOW_MODEL=deepseek-ai/DeepSeek-V3

# DeepSeekï¼ˆå¤‡é€‰ï¼‰
# DEEPSEEK_API_KEY=sk-your-key
# DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
# DEEPSEEK_MODEL=deepseek-chat

# OpenAIï¼ˆå¤‡é€‰ï¼‰
# æ³¨æ„ï¼šä½¿ç”¨OpenAIæ—¶éœ€è¦åŒæ—¶è®¾ç½®SILICONFLOW_BASE_URL
# OPENAI_API_KEY=sk-your-key
# SILICONFLOW_BASE_URL=https://api.openai.com/v1
# SILICONFLOW_MODEL=gpt-4

# Embeddingæ¨¡å‹ï¼ˆç”¨äºRAGï¼Œå¯é€‰ï¼Œé»˜è®¤BAAI/bge-m3ï¼‰
# EMBEDDING_MODEL=BAAI/bge-m3

# -----------------------------------------------------------------------------
# 2. è”ç½‘æœç´¢é…ç½®ï¼ˆå¯é€‰ä½†æ¨èï¼‰
# -----------------------------------------------------------------------------

GOOGLE_CSE_API_KEY=your-google-api-key
GOOGLE_CSE_CX=your-search-engine-id
# GOOGLE_CSE_GL=cn
# GOOGLE_CSE_HL=zh-CN

# å›½å†…ç½‘ç»œéœ€é…ç½®ä»£ç†
# GOOGLE_CSE_PROXY=http://host.docker.internal:7890
# HTTP_PROXY=http://host.docker.internal:7890
# HTTPS_PROXY=http://host.docker.internal:7890

# -----------------------------------------------------------------------------
# 3. è¯­éŸ³é…ç½®ï¼ˆå¯é€‰ï¼‰
# -----------------------------------------------------------------------------

DASHSCOPE_API_KEY=sk-your-dashscope-key
DASHSCOPE_REGION=cn  # æµ·å¤–Keyç”¨ intl

# TTSéŸ³è‰²ï¼ˆå¿…é¡»å…ˆå¤åˆ»ï¼Œè§æ–‡æ¡£ï¼‰
QWEN_TTS_VOICE=your-output-voice-id

# TTSå‚æ•°ï¼ˆå¯é€‰ï¼‰
# QWEN_TTS_SPEECH_RATE=0    # è¯­é€Ÿ -50~50
# QWEN_TTS_PITCH_RATE=0      # éŸ³è°ƒ -50~50
# QWEN_TTS_VOLUME=0          # éŸ³é‡ -50~50

# è¯­éŸ³è§¦å‘ï¼ˆå¯é€‰ï¼‰
# VOICE_REPLY_ON_TEXT=1  # æ‰€æœ‰æ–‡å­—éƒ½ç”¨è¯­éŸ³å›å¤
# VOICE_REPLY_KEYWORDS=è¯­éŸ³,æ¥æ®µè¯­éŸ³  # å‘½ä¸­å…³é”®è¯æ‰è¯­éŸ³å›å¤

# -----------------------------------------------------------------------------
# 4. å›¾ç‰‡ç†è§£é…ç½®ï¼ˆå¯é€‰ï¼Œä¸è¯­éŸ³å…±ç”¨DASHSCOPE_API_KEYï¼‰
# -----------------------------------------------------------------------------

# QWEN_VL_MODEL=qwen-vl-plus-latest

# -----------------------------------------------------------------------------
# 5. ä¸»åŠ¨äº’åŠ¨é…ç½®ï¼ˆå¯é€‰ï¼‰
# -----------------------------------------------------------------------------

PROACTIVE_ENABLED=1
PROACTIVE_INTERVAL_MINUTES=5      # æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
PROACTIVE_IDLE_HOURS=8            # å¤šå°‘å°æ—¶æœªèŠè§¦å‘
PROACTIVE_MAX_PER_DAY=2           # æ¯å¤©æœ€å¤šä¸»åŠ¨å‡ æ¬¡
PROACTIVE_COOLDOWN_MINUTES=240    # ä¸»åŠ¨äº’åŠ¨å†·å´æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

# -----------------------------------------------------------------------------
# 6. æ¨é€é…ç½®ï¼ˆå¯é€‰ï¼‰
# -----------------------------------------------------------------------------

# å¤©æ°”æ¨é€
WEATHER_PUSH_ENABLED=1
WEATHER_PUSH_HOUR=8
WEATHER_PUSH_MINUTE=20

# GitHubå‘¨æ¦œ
GITHUB_WEEKLY_ENABLED=1
GITHUB_WEEKLY_USER_ID=123456789   # ä½ çš„QQå·

# è´¢ç»æ—¥æŠ¥
FINANCE_DAILY_ENABLED=1
FINANCE_DAILY_USER_ID=123456789
FINANCE_DAILY_HOUR=15
FINANCE_DAILY_MINUTE=35
FINANCE_DAILY_TOP_N=5

# RSSæºï¼ˆé€—å·åˆ†éš”ï¼Œç©ºåˆ™ä½¿ç”¨é»˜è®¤ï¼‰
# RSS_FEEDS=https://rsshub.app/weibo/search/hot,https://rsshub.app/zhihu/hot

# -----------------------------------------------------------------------------
# 7. HTTP APIé…ç½®ï¼ˆå¯é€‰ï¼‰
# -----------------------------------------------------------------------------

# STM32_API_KEY=your-api-key-for-external-devices

# -----------------------------------------------------------------------------
# 8. OneBoté…ç½®ï¼ˆå¿…é¡»ä¸NapCatä¸€è‡´ï¼‰
# -----------------------------------------------------------------------------

ONEBOT_ACCESS_TOKEN=your-random-token-here

# -----------------------------------------------------------------------------
# 9. æ°”æ³¡åˆ†å‰²é…ç½®ï¼ˆå¯é€‰ï¼‰
# -----------------------------------------------------------------------------

# XIAOA_BUBBLE_JSON=true  # å¯ç”¨LLMæ°”æ³¡JSONè§£æï¼ˆå®éªŒæ€§ï¼‰
```

### 10.2 docker-compose.ymlè¯¦è§£

```yaml
version: '3.8'

services:
  # NapCat: QQåè®®æ¡¥æ¥
  napcat:
    image: mlikiowa/napcat-docker:latest
    container_name: napcat
    restart: unless-stopped
    ports:
      - "6099:6099"  # WebUI
    volumes:
      - ./napcat/config:/root/.config/napcat  # OneBoté…ç½®
      - ./napcat/qq:/root/.config/QQ  # QQç™»å½•æ•°æ®
    environment:
      - NAPCAT_UID=1000
      - NAPCAT_GID=1000

  # NoneBot2: æœºå™¨äººæ ¸å¿ƒ
  nonebot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: nonebot
    restart: unless-stopped
    ports:
      - "8080:8080"  # OneBot WebSocket
    volumes:
      - ./bot:/app  # ä»£ç æŒ‚è½½ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
      - ./bot/plugins/companion_core/data.db:/app/plugins/companion_core/data.db  # æ•°æ®åº“æŒä¹…åŒ–
      - ./bot/plugins/companion_core/chroma_db:/app/plugins/companion_core/chroma_db  # RAGæŒä¹…åŒ–
    environment:
      - ONEBOT_ACCESS_TOKEN=${ONEBOT_ACCESS_TOKEN}
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      # ... å…¶ä»–ç¯å¢ƒå˜é‡ä».envè¯»å–
    depends_on:
      - napcat
    command: ["python", "bot.py"]
```

---

## é™„å½•

### A. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| æ¶ˆæ¯å“åº”å»¶è¿Ÿ | 1-3s | ä»æ¥æ”¶åˆ°å‘é€é¦–æ¡ |
| LLMè°ƒç”¨è€—æ—¶ | 0.5-2s | å–å†³äºæ¨¡å‹å’Œç½‘ç»œ |
| RAGæ£€ç´¢è€—æ—¶ | 50-100ms | ChromaDBæœ¬åœ°æŸ¥è¯¢ |
| æ‰“å­—å»¶è¿ŸèŒƒå›´ | 0.35s-15s | æ ¹æ®æ¶ˆæ¯é•¿åº¦åŠ¨æ€ |
| å†…å­˜å ç”¨ | 200-500MB | ä¸å«æ¨¡å‹ |
| æ•°æ®åº“å¤§å° | 10MB/ç”¨æˆ·/å¹´ | ä¼°ç®— |

### B. æ‰©å±•æ¥å£

å¦‚éœ€æ·»åŠ æ–°åŠŸèƒ½ï¼Œå¯ä»¥å®ç°ä»¥ä¸‹é’©å­ï¼š

```python
# handlers.py æ·»åŠ æ–°æŒ‡ä»¤è¯†åˆ«
async def _handle_my_feature(user_id: int, text: str) -> str | None:
    if not text.startswith("æˆ‘çš„æŒ‡ä»¤"):
        return None
    # å®ç°åŠŸèƒ½é€»è¾‘
    return "å›å¤å†…å®¹"

# åœ¨ handle_private_chat ä¸­è°ƒç”¨
my_reply = await _handle_my_feature(user_id, user_input)
if my_reply:
    await _send_and_finish(my_reply, user_id=user_id)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0  
**æœ€åæ›´æ–°**: 2025-01  
**ä½œè€…**: xiaobendaoke
