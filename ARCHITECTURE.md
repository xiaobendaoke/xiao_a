# 小a (XiaoA) 全景架构与功能详解

本文档旨在用通俗易懂的语言，详细揭秘小a（一个拥有真实人设的 AI 伴侣）的所有功能背后的实现逻辑。

---

## 1. 核心大脑：她怎么思考？(LLM Core)

小a不是简单的"一问一答"机器人，她拥有复杂的思维链条。

### 1.1 动态 Prompt 构建
每次你发消息时，系统会瞬间拼装出一个包含所有上下文的"超级 Prompt"发送给大模型。这个 Prompt 像千层饼一样包含：

1.  **世界设定 (World Info)**
    - 注入当前真实时间（"现在是周五下午3点"）、天气（"正在下雨"）。
    - *实现原理*：`utils/world_info.py` 实时生成。
2.  **人设核心 (Persona)**
    - 注入性格定义（"你叫小a，20岁，调皮，女朋友"）和说话禁忌（"禁止像客服一样说话"）。
    - *实现原理*：`persona.py` 定义死模板。
3.  **用户画像 (Profile)**
    - 注入你的个人信息（"用户叫X，喜欢吃辣，住在北京"）。
    - *实现原理*：`db.py` 从 SQLite 数据库读取 `user_profile` 表。
4.  **长期记忆 (RAG)**（稍后详细讲）
5.  **当前心情 (Mood)**
    - 注入心情值（"心情值: +10 (开心)"）。
    - *实现原理*：`mood.py` 维护的一个数值，随对话波动。

---

## 2. 深度认知：她怎么"懂"你？

这部分是小a区别于普通 AI 的核心。她不仅仅是被动回答，而是在默默观察和学习。

### 2.1 用户洞察 (User Insights)
-   **功能**：她会分析你的聊天记录，提取出你的兴趣、习惯和偏好。
-   **实现逻辑** (`llm_insights.py`)：
    1.  每隔一段时间（或积累一定对话后），后台把最近 30 条记录丢给 LLM。
    2.  让 LLM 分析："这个用户喜欢什么？有什么习惯？"
    3.  LLM 输出 JSON：`{"interest": "编程", "habit": "熬夜", "topic": "DeepSeek"}`。
    4.  存入数据库，供后续"主动话题"使用。

### 2.2 主动互动 (Proactive System)
-   **功能**：如果你很久没理她，她会主动找你聊天（不是定时的早安，而是真的找话题）。
-   **实现逻辑** (`proactive.py`)：
    1.  **扫描**：每5分钟检查一次，找出"超过8小时没说话"的用户。
    2.  **决策**：结合你的【画像】和【最近聊天记录】，问 LLM："现在去搭讪合适吗？说什么话题？"
    3.  **发送**：如果 LLM 说合适，就生成一句开场白（比如"这么晚还在忙呀？"）发给你。

---

## 3. 记忆系统：三层记忆模型

### 3.1 瞬时记忆 (Context)
-   **内容**：最近 20 轮对话。
-   **作用**：维持当前话题连贯性。

### 3.2 语义长期记忆 (RAG)
-   **内容**：海量历史对话片段。
-   **实现逻辑** (`rag_core.py`)：
    -   **存储**：每段有意义的对话都会被转成向量（Vector）存入 ChromaDB。
    -   **检索**：当你提到"火锅"时，系统去数据库捞出半年前聊过"海底捞"的记录。
    -   **防干扰**：如果你问的是**当下新闻**（"今天什么大瓜"），系统会**强制跳过**这层，防止被旧闻误导。

### 3.3 备忘录 (Memo)
-   **内容**：你显式要求记下来的笔记。
-   **实现逻辑** (`memo.py`)：
    -   **写入**：识别"记一下：xxx"、"memo：xxx"指令，存入独立表。
    -   **查询**：识别"查询笔记 wifi"等指令，关键词搜索。
    -   *区别于 RAG，这是精准的、用户可控的笔记。*

---

## 4. 感官与表达：能听、能看、会说

小a拥有多模态能力，极其拟人化。

### 4.1 语音交互 (Voice)
-   **听 (ASR)**：
    -   接入阿里云 `Paraformer` 模型。OneBot 收到的语音条会自动转成文字。
-   **说 (TTS)**：
    -   接入阿里云 `Qwen Realtime` 语音模型 (`qwen3-tts`)。
    -   **情感联动引擎** (`voice/tts.py`)：
        -   系统会读取当前的 Mood 值（-60 到 +60）。
        -   **Mood > 0 (开心)**：调用 TTS 时自动**提高语速**、**提高音调**、**增大音量**。
        -   **Mood < 0 (难过)**：自动**降低语速**、**压低语调**。
        -   *这让她说话有情绪，而不仅是念稿子。*

### 4.2 视觉能力 (Vision)
-   **看图**：
    -   你发图片时，`plugins/llm_vision` 会调用视觉模型（GPT-4V/Qwen-VL）。
    -   支持"先发图再发问"：你可以发一张图，过几秒再问"这是哪里？"，她能关联起来。

### 4.3 拟人化输出 (Humanization)
-   **气泡分割** (`bubble_splitter.py`)：
    -   自动把长回复拆成多条短消息（根据换行和标点）。拒绝小作文刷屏。
-   **打字节奏** (`send_rhythm.py`)：
    -   计算句子长度 -> 模拟人类打字耗时 -> 加上随机抖动 -> 真的等几秒再发。
    -   状态栏会显示"正在输入..."。
-   **防打断** (`handlers.py`)：
    -   如果她正要回复，但检测到"对方正在输入..."，她会**中断发送**，等你先说完。

---

## 5. 主动情报系统：你的私人资讯台

她不仅仅陪聊，还能帮你盯着世界。

### 5.1 智能新闻推送 (Info Agent)
-   **实现逻辑** (`info_agent/`):
    1.  定时抓取数百条 RSS 标题（微博热搜、科技新闻等）。
    2.  结合你的 **User Insights**（兴趣），让 LLM 挑出**一条**你最可能感兴趣的。
    3.  **改写**：LLM 会把新闻改写成"女朋友分享八卦"的口吻（"诶你看那个..."），而不是转发链接。
    4.  **去重**：已推送过的内容绝不重复。

### 5.2 每日天气播报 (Weather Push)
-   **实现逻辑** (`weather_push.py`):
    1.  每天早晨 8:20 定时触发。
    2.  根据你所在的城市查 Open-Meteo 天气。
    3.  生成拟人化提醒。
    4.  **特色**：如果 Mood 允许，她会**发一条语音**喊你起床/带伞，而不只是文字。

### 5.3 GitHub 周榜 (GitHub Weekly)
-   **实现逻辑** (`github_weekly_push.py`):
    -   每周日晚 20:30，自动拉取 GitHub Trending。
    -   LLM 总结 TOP5 项目的骚操作，推送到你的私聊。

---

## 6. 生活助理与技能包

### 6.1 日程提醒 (Scheduler)
-   **指令**："提醒我 10分钟后 关火"、"明早8点叫我"。
-   **逻辑**：`scheduler_custom.py` 解析时间自然语言 -> 存入任务队列 -> 到点触发拟人化提醒。

### 6.2 实时联网搜索
-   **指令**：问实时性问题（"今天金价"、"纳斯达克指数"）。
-   **逻辑**：DuckDuckGo 搜索 -> 抓取前3条网页 -> LLM 阅读总结 -> 回复。

### 6.3 股票分析专员 (`llm_stock`)
-   **指令**：发送股票代码（"600519"、"tsla"）。
-   **逻辑**：
    -   Tushare/YFinance 接口拉取实时行情+K线。
    -   LLM 分析技术形态（均线、MACD）。
    -   生成一份"看似专业但其实在安慰你"的股评。

### 6.4 URL 自动摘要
-   **指令**：直接发一个公众号/新闻链接。
-   **逻辑**：她会自动判断"这是否需要读一下" -> 抓取网页正文 -> 总结给你看（"太长不看版"）。
