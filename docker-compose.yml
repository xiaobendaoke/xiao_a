services:
  napcat:
    image: mlikiowa/napcat-docker:latest
    container_name: napcat
    environment:
      - NAPCAT_UID=${NAPCAT_UID:-1000}
      - NAPCAT_GID=${NAPCAT_GID:-1000}
      - TZ=Asia/Shanghai
    ports:
      - "6099:6099"   # NapCat WebUI
      - "3000:3000"
      - "3001:3001"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./napcat/qq:/app/.config/QQ
      - ./napcat/config:/app/napcat/config
    restart: unless-stopped
  
  nonebot:
    image: ${NONEBOT_IMAGE:-qqbot-nonebot:local}
    build:
      context: ./bot
    container_name: nonebot
    working_dir: /app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./bot:/app
      # 记忆/状态数据库（SQLite），单独挂载保证容器重建不丢
      - ./bot/plugins/companion_core/data.db:/app/plugins/companion_core/data.db
    extra_hosts:
      # 让容器能访问宿主机代理（Linux 下默认没有 host.docker.internal）
      - "host.docker.internal:host-gateway"
    env_file:
      - ./bot/.env
    environment:
      - ONEBOT_ACCESS_TOKEN=mybot_2026_token
      - ENVIRONMENT=prod
      - HOST=0.0.0.0
      - PORT=8080
      - TZ=Asia/Shanghai
      # 配置 bot 容器的代理（用于直连 FT/BBC 等 RSS，以及 LLM API）
      - http_proxy=http://host.docker.internal:7890
      - https_proxy=http://host.docker.internal:7890
      # 排除内部网络，避免 RSSHub 等内网服务走代理
      - no_proxy=localhost,127.0.0.1,rsshub,redis,napcat
    ports:
      - "8080:8080"
    command: ["python", "bot.py"]
    restart: unless-stopped

    # 语音已切到 DashScope（ASR/TTS），不再依赖 GPT-SoVITS

  # === RSSHub 信息聚合服务 ===
  rsshub:
    image: diygod/rsshub:latest
    container_name: rsshub
    restart: unless-stopped
    ports:
      - "1200:1200"
    environment:
      - NODE_ENV=production
      - CACHE_TYPE=redis
      - REDIS_URL=redis://redis:6379/
      - CACHE_EXPIRE=600
      - TZ=Asia/Shanghai
      # 配置代理访问国外源（如 BBC/Reuters）
      - PROXY_URI=http://host.docker.internal:7890
      # 防止国内源走代理变慢（可选，根据需要调整）
      # - PROXY_URL_REGEX=.*(github|bbc|reuters|hackernews|v2ex|solidot).*
      # 需要 Cookie 的源
      - WEIBO_COOKIES=${WEIBO_COOKIES}
      - ZHIHU_COOKIES=${ZHIHU_COOKIES}
    depends_on:
      - redis
    extra_hosts:
      - "host.docker.internal:host-gateway"

  redis:
    image: redis:alpine
    container_name: rsshub-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data

volumes:
  redis-data:
