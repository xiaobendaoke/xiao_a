services:
  napcat:
    image: mlikiowa/napcat-docker:latest
    container_name: napcat
    environment:
      - NAPCAT_UID=${NAPCAT_UID:-1000}
      - NAPCAT_GID=${NAPCAT_GID:-1000}
      - TZ=Asia/Shanghai
    ports:
      - "6099:6099"
      - "3000:3000"
      - "3001:3001"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./napcat/qq:/app/.config/QQ
      - ./napcat/config:/app/napcat/config
    restart: unless-stopped

  nonebot:
    image: ${NONEBOT_IMAGE:-qqbot-nonebot:local}
    build:
      context: ./bot
    container_name: nonebot
    working_dir: /app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./bot:/app
      - ./bot/plugins/companion_core/data.db:/app/plugins/companion_core/data.db
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - ./bot/.env
    environment:
      - ONEBOT_ACCESS_TOKEN=mybot_2026_token
      - ENVIRONMENT=prod
      - HOST=0.0.0.0
      - PORT=8080
      - TZ=Asia/Shanghai
      - http_proxy=http://host.docker.internal:7890
      - https_proxy=http://host.docker.internal:7890
      - no_proxy=localhost,127.0.0.1,rsshub,redis,napcat
    ports:
      - "8080:8080"
    command: ["python", "bot.py"]
    restart: unless-stopped

  # === RSSHub 信息聚合服务 ===
  rsshub:
    image: diygod/rsshub
    restart: always
    ports:
      - '1200:1200'
    environment:
      NODE_ENV: production
      CACHE_TYPE: redis
      REDIS_URL: 'redis://redis:6379/'
      PUPPETEER_WS_ENDPOINT: 'ws://browserless:3000'
      PUPPETEER_REAL_BROWSER_SERVICE: 'http://real-browser:3000'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:1200/healthz']
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis
      - browserless

  real-browser:
    image: ghcr.io/hyoban/puppeteer-real-browser-hono
    restart: always
    ports:
      - '3002:3000'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3

  browserless:
    image: browserless/chrome
    restart: always
    ulimits:
      core:
        hard: 0
        soft: 0
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/pressure']
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:alpine
    restart: always
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s

volumes:
  redis-data: